<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' data: https://ssl.gstatic.com 'unsafe-eval'; style-src 'self' 'unsafe-inline'; media-src *; img-src 'self' data: content:;">
    <meta name="viewport" content="initial-scale=1, width=device-width, viewport-fit=cover, user-scalable=no">
    <title>Diagnóstico EchoTap</title>
    <style>
        body { background-color: #121212; color: #e0e0e0; font-family: monospace, sans-serif; padding: 10px; font-size: 14px; }
        h1 { color: #bb86fc; }
        #logs { list-style-type: none; padding: 0; margin: 0; }
        #logs li { padding: 8px; border-bottom: 1px solid #333; word-wrap: break-word; }
        .log-time { color: #888; margin-right: 10px; }
        .log-info { color: #03dac6; }
        .log-success { color: #4caf50; font-weight: bold; }
        .log-error { color: #cf6679; font-weight: bold; }
        .log-warn { color: #ffab40; }
    </style>
</head>
<body>
    <h1>Relatório de Inicialização do EchoTap</h1>
    <ul id="logs"></ul>

    <!-- O Cordova.js DEVE ser o primeiro script relacionado ao Cordova a ser carregado -->
    <script src="cordova.js"></script>
    
    <!-- Scripts da biblioteca, se necessário. Por agora, vamos mantê-los para verificar se carregam -->
    <script src="noxss/dist/noxss.js"></script>

    <script>
        // ===================================================================
        // SCRIPT DE DIAGNÓSTICO
        // Este script não tem dependências externas e roda imediatamente.
        // ===================================================================

        const logList = document.getElementById('logs');
        let stepCounter = 1;

        // Função de log visual para sabermos o que está acontecendo
        function log(message, type = 'info') {
            const li = document.createElement('li');
            const time = new Date().toLocaleTimeString();
            
            li.innerHTML = `<span class="log-time">${time}</span><span class="log-${type}">[Passo ${stepCounter++}] ${message}</span>`;
            logList.appendChild(li);
            console.log(`DIAGNOSTICO: ${message}`);
        }
        
        log("Iniciando script de diagnóstico.");

        // --- Verificação de Ambiente ---
        log(`User Agent: ${navigator.userAgent}`);
        const isCordovaApp = typeof window.cordova !== 'undefined';
        log(`Verificando 'window.cordova'... Resultado: ${isCordovaApp}`, isCordovaApp ? 'success' : 'warn');

        // --- Verificação de Bibliotecas ---
        const isNoxssLoaded = typeof Noxss !== 'undefined';
        log(`Verificando 'Noxss' global... Resultado: ${isNoxssLoaded}`, isNoxssLoaded ? 'success' : 'warn');
        if (!isNoxssLoaded) {
            log("AVISO: A biblioteca Noxss não foi carregada. Verifique o caminho 'noxss/dist/noxss.js'.", "warn");
        }
        
        // --- Lógica de Inicialização do Cordova ---
        function onDeviceReady() {
            log("EVENTO 'deviceready' DISPARADO!", 'success');
            log(`Plataforma Cordova: ${window.device.platform} ${window.device.version}`);
            
            // Aqui é onde a lógica principal do seu app começaria
            log("Aplicativo pronto para interagir com plugins nativos.", "success");
            document.body.style.backgroundColor = '#003300'; // Feedback visual de sucesso
        }

        function onDeviceReadyTimeout() {
            log("TIMEOUT! O evento 'deviceready' não foi disparado após 10 segundos.", 'error');
            log("Possíveis causas: 1) Erro no arquivo 'cordova.js' (verifique o console de erros nativo). 2) Um plugin está falhando ao inicializar. 3) Problema na Content-Security-Policy (CSP).", 'error');
            document.body.style.backgroundColor = '#330000'; // Feedback visual de erro
        }

        if (isCordovaApp) {
            log("Ambiente Cordova detectado. Aguardando 'deviceready'...");
            document.addEventListener('deviceready', onDeviceReady, false);
            // Adiciona um timeout para nos avisar se o evento nunca chegar
            setTimeout(onDeviceReadyTimeout, 10000); 
        } else {
            log("Ambiente de navegador detectado. O 'deviceready' não será disparado. A funcionalidade nativa não estará disponível.", 'warn');
            // No modo de diagnóstico, não disparamos o evento manualmente para não criar falsos positivos.
            // O objetivo é ver se ele dispara *naturalmente* no dispositivo.
        }

    </script>
</body>
</html>